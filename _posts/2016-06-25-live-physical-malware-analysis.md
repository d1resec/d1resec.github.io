---
id: 144
title: Live Physical Malware Analysis
date: 2016-06-25T19:41:25+00:00
author: nwalsh
layout: post
guid: https://nwalsh.me/?p=144
permalink: /?p=144
categories:
  - General
  - Security
tags:
  - analysis
  - malware
  - networking
  - physical
  - virtual
---
This post is the culmination of a few days of research into setting up a physical malware lab. It contains basic information for people who want to set up a physical lab to get started.

&nbsp;

In order to analyze malware often it is recommended to run malware in a virtual machine. The benefits for this are obvious: the malware should only infect the virtual host, it is easier to reimage a virtual machine using snapshots, and that you can set up a test environment easier.

However, nowadays it is known that malware has become more sophisticated leading to [virtual machine aware malware](http://www.computerweekly.com/news/2240169662/VM-aware-viruses-on-the-rise). This malware checks for signatures on the guest that show it is running in a sandbox, and due to this it will alter its behavior. Usually this means that the malware does not execute normally, as the author understands someone might be trying to analyze or reverse engineer it. Additionally, [VM escapes](http://www.darkreading.com/endpoint/xen-patches-worst-ever-virtual-machine-escape-vulnerability/d/d-id/1322925) have become a [new technique](https://nakedsecurity.sophos.com/2015/05/14/the-venom-virtual-machine-escape-bug-what-you-need-to-know/) for malware authors to attempt to infect the computer hosting the virtual machine. These are the types of risks that one must analyze before creating their malware analysis lab. This leads us to this question:

# How can a physical, as opposed to virtual, malware lab be as efficient as a virtual one?

One of the main benefits of a virtual malware lab is the ability to restore the virtual machine to a clean state easily. Once the malware has infected the computer and the analyst has pulled the necessary information, the virtual machine needs to be reverted. This is as simple as right clicking the virtual machine > snapshots > revert to earlier snapshot. How can we achieve the same effect with a physical lab?

The answer is PXE booting. [PXE booting](https://en.wikipedia.org/wiki/Preboot_Execution_Environment) from the network allows a physical host to obtain a image from another computer (the one supplying DHCP), and use that to boot from. Therefore, the client machine can get infected, and reboot from the clean image supplied from the DHCP server. However, this requires that there are two computers on the same network, the client to be infected, and a DHCP server supplying the image. Although this process might be a bit longer than restoring a snapshot, as far as I know this is the best way to restore images on a physical host in an automated fashion. As far as networking goes, this part cannot be automated. It will require actual networking gear, which is a downside. However, if this is for a corporate environment, many of them will have a small 4 port switch/router that can be used.

How can we start PXE booting? First, ensure that the client is able to PXE boot, you can check this by going into the BIOS boot from settings. If the client can PXE boot then on a separate server we will need to set up something like [FOG](https://fogproject.org/) or [other similar software](http://lmgtfy.com/?q=PXE+boot+software). Make sure the clean image has all the necessary analysis tools, so that those will not have to be reloaded every time the machine is restored. Additionally, other [networking tools](https://www.bro.org/) can be installed on the imaging server so that by configuring the client to route traffic through this server, it can be inspected as it passes.